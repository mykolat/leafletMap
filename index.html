<!DOCTYPE html>
<html>

<head>
    <title>leaflet-sidebar example</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="./bower_components/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="./src/L.Control.Sidebar.css"/>
    <link rel="stylesheet" href="./src/list.css"/>

    <style>
        body {
            font-family: sans-serif;
        }

        #map {
            width: 100%;
            height: 600px;
        }

        #sidebar {
            padding: 40px 0;
            font-family: monospace;
        }
    </style>

</head>

<body>

<div id="views">
    <div class="view" id="main-view">
        <div id="sidebar"></div>
        <div id="map"></div>
    </div>
    <div class="view" style="display: none;" id="second-view">

        <div id="car-view">

        </div>
    </div>
</div>
<script src="./bower_components/jquery/dist/jquery.min.js"></script>
<script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
<script src="./bower_components/leaflet/dist/leaflet.js"></script>
<script src="./src/L.Control.Sidebar.js"></script>
<script src='http://api.tiles.mapbox.com/mapbox.js/v0.6.7/mapbox.js'></script>
<link href='http://api.tiles.mapbox.com/mapbox.js/v0.6.7/mapbox.css' rel='stylesheet'/>

<script>
    var MapService = function () {
        var map;

        function init() {
            map = L.map('map');
            L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v8/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibXlrb2xhdCIsImEiOiJjajB3ajEyNjQwMDB2MzNwOTN6NGszb2ZyIn0.1bVvnPjlL_cxJwXxwxWHpA', {
                maxZoom: 18,
                attribution: 'Map data &copy; OpenStreetMap contributors'
            }).addTo(map);
            map.setView([50.1369745, 8.696875300000002], 12);
        }

        function addMarkerListeners(marker) {
            marker.on("click", clickListener);
            marker.on("mouseover", mouseOverListener);
            marker.on("mouseout", mouseOutListener);
            SidebarService.getSidebar().on("hide", MarkerService.handleSidebarHide)
        }

        function clickListener(e) {
            MarkerService.handleClick(this)
            if (MarkerService.isActive()) {
                SidebarService.show(this, map._container.offsetWidth, e.originalEvent.layerX);
            } else {
                SidebarService.getSidebar().hide();
            }
        }

        function mouseOverListener(e) {
            MarkerService.handleMouseOver(this);
            SidebarService.show(this, map._container.offsetWidth, e.originalEvent.layerX);
        }

        function mouseOutListener() {
            MarkerService.handleMouseOut(this);
            if (MarkerService.isActive()) {
                SidebarService.show();
            } else {
                SidebarService.getSidebar().hide();
            }
        }

        return {
            getMap: function () {
                if (!map) {
                    init();
                }
                return map;
            },
            addSidebar: function (sidebar) {
                this.getMap().addControl(sidebar);
            },
            addMarker: function (marker) {
                marker.addTo(this.getMap());
                //init marker listeners
                addMarkerListeners(marker);
            },
            setMarkers: function (markers) {
                var that = this;
                markers.forEach(function (marker) {
                    that.addMarker(marker);
                });
            }
        }

    }();
    var VehicleService = function () {
        var vehicle = [{
            "id": 1,
            "model": "S - Fiat 500 Cabrio",
            "vehicleClass": "SUBCOMPACT",
            "vehicleState": "AVAILABLE",
            "description": "Comfort trip<br>Max speed <b>190km/h</b><br>Price <b>2USD/h</b>",
            "image": "content_fiat_500.jpg"
        }, {
            "id": 2,
            "model": "L - Peugeot 2008",
            "vehicleClass": "LUX",
            "vehicleState": "AVAILABLE",
            "description": "Fast turbo engine<br>Max speed <b>290km/h</b><br>Price <b>4USD/h</b>",
            "image": "content_peugot_2008.jpg"
        }, {
            "id": 3,
            "model": "XL - Peugeot 308",
            "vehicleClass": "LARGE",
            "vehicleState": "AVAILABLE",
            "description": "Super fast turbo engine<br>Capacity <b>9 person</b><br>Price <b>7USD/h</b>",
            "image": "content_peugot_308_sw.jpg"
        }, {
            "id": 4,
            "model": "XXL - CitroÃ«n Jumpy",
            "vehicleClass": "FULLVAN",
            "vehicleState": "AVAILABLE",
            "description": "For big family<br>Engine <b>136 bhp</b><br>Price <b>9.99USD/h</b>",
            "image": "content_citroen_jumpy.jpg"
        }];


        return {
            getVehicles: function (value) {
                return vehicle.slice(value)
            },
            getCarInfo: function (id) {
                //no search for now
                return vehicle[id - 1]
            }
        }
    }();
    var SidebarService = function () {
        var sidebar;
        var clickListeners = [];

        function init() {
            sidebar = L.control.sidebar('sidebar', {
                closeButton: true,
                position: 'right',
                autoPan: false
            });
            $(sidebar.getContainer())
                .delegate("li", "click", function () {
                    /* Unselect the currently selected item */
                    console.log("clicked")
                    var carId = $(this).data("id");
                    clickListeners.forEach(function (listener) {
                        listener(carId);
                    })
                })
        }

        function defineSidebarPosition(mapWidth, position) {
            if (mapWidth && mapWidth / 2 > position) {
                return "right"
            }
            return "left"
        }

        return {
            getSidebar: function () {
                if (!sidebar) {
                    init()
                }
                return sidebar;
            },
            addClickListener: function (listener) {
                clickListeners.push(listener);
            },
            show: function (marker, mapWidth, position) {
                var data = MarkerService.getMarkerContent(marker);
                $ul = document.createElement("ul");
                var markup = "<li data-id='${id}'><img src='./images/${image}'><h3>${model}</h3><p>{{html description}}</p></li>";
                $.template("carListItem", markup);
                $.tmpl("carListItem", data.vehicles)
                    .appendTo($ul);
                this.getSidebar().setContent($ul);

                this.getSidebar().show(defineSidebarPosition(mapWidth, position));
            }
        }
    }();
    var MarkerService = function () {
        var markers,
            activeMarker,
            greenIcon, blueIcon;

        function getMarkers(callback) {
            $.ajax({
                url: './data.json',
                type: 'get',
                dataType: 'json',
                success: callback
            });
        }

        function init(callback) {
            markers = [];

            greenIcon = new L.Icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            blueIcon = new L.Icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            getMarkers(function (markersData) {
                markersData.vehicle.forEach(function (dataElement, i) {
                    var marker = L.marker([dataElement.latitude, dataElement.longitude]);
                    marker.options.data = {
                        content: dataElement
                    };
                    marker.options.data.vehicles = VehicleService.getVehicles(i % 3);
                    markers.push(marker);
                });
                callback();
            })
        }


        function setActiveMarker(marker) {
            if (marker) {
                activeMarker = marker;
                highlightMarker(activeMarker)
            } else if (activeMarker) {
                unhighlightMarker(activeMarker)
                activeMarker = null;
            }
        }

        function highlightMarker(marker) {
            marker.setIcon(greenIcon);
        }

        function unhighlightMarker(marker) {
            marker.setIcon(blueIcon);
        }


        return {
            getMarkers: function (callback) {
                if (!markers) {
                    init(function () {
                        callback(markers);
                    });
                } else {
                    callback(markers);
                }
            },

            getMarkerContent: function (marker) {
                if (marker) {
                    return marker.options.data;
                } else if (activeMarker) {
                    return activeMarker.options.data;
                }
            },

            isActive: function () {
                return !!activeMarker;
            },

            handleClick: function (marker) {
                if (!activeMarker) {
                    setActiveMarker(marker);
                    return true;
                }

                if (marker != activeMarker) {
                    unhighlightMarker(activeMarker);
                    setActiveMarker(marker);
                    return true;
                }
                setActiveMarker(false);
                return false;
            },
            handleMouseOver: function (marker) {
                highlightMarker(marker)
            },
            handleMouseOut: function (marker) {
                if (marker != activeMarker) {
                    unhighlightMarker(marker)
                }
            },
            handleSidebarHide: function () {
                setActiveMarker(false);
            }
        }


    }();
    var ViewsService = function () {
        var views = ["#main-view", "#second-view", "#car-view"],
            activeView = 0;

        function changeActiveView(active) {
            $(views[activeView]).hide()
            activeView = active;
            $(views[activeView]).show()
        }

        return {
            getViews: function () {
                return views
            },

            showVehicle: function (vehicle) {
                var markup = "<img src='./images/${image}'><h3>${model}</h3><p>{{html description}}</p>";

                changeActiveView(1)

                //updateVehicleBlock
                $(views[2]).empty();
                $.template("vehicle", markup);
                $.tmpl("vehicle", vehicle)
                    .appendTo($(views[2]));
                $(views[2]).click(function () {
                    changeActiveView(0)
                })

            },
            init: function () {

            }
        }
    }();

    function init() {
        MapService.addSidebar(SidebarService.getSidebar());

        MarkerService.getMarkers(function (markers) {
            MapService.setMarkers(markers)
            SidebarService.addClickListener(
                function (id) {
                    ViewsService.showVehicle(VehicleService.getCarInfo(id))
                }
            )
        });
    }
    $(document).ready(init);

</script>
</body>

</html>
